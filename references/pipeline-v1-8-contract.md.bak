# Pipeline v1.8 Contract (Agent Teams)

Source of truth: `PIPELINE_FLOWCHART_V1_8_EMOJI.md`.

## 1) Global State

```text
ReEntry = 0
ReEntry_MAX = 2
Snapshots = {S1, S2, S3}
HALT_TIMEOUT = 30min
G2 = 20 weighted lines
G3 = 30 weighted lines
Weight: critical paths Ã—2, others Ã—1
```

## 2) Lane Routing

- Step 1 classifies task into L1/L2/L3 + type A/B/C.
- Type A (ä¸šåŠ¡/æ¶æ„): coding agent ç”¨ sonnet/medium, review agent ç”¨ codex/high å®¡æŸ¥, test agent ç”¨ codex/medium æµ‹è¯•.
- Type B (ç®—æ³•/æ€§èƒ½): coding agent ç”¨ codex/medium, review agent ç”¨ sonnet/medium å®¡æŸ¥, test agent ç”¨ sonnet/medium æµ‹è¯•.
- åˆ†æ­§ä»²è£: opus/medium + codex/xhigh.
- Type C (æ··åˆ): split into sub-tasks, route A/B separately.
- L1 â†’ fast lane.
- L2/L3 â†’ standard lane with mandatory Step 1.5.

## 3) Step 1.5 Spec-Kit Gate (L2/L3 Only)

Based on GitHub Spec-Kit (https://github.com/github/spec-kit) methodology.

Required artifacts before Step 2:
- `specs/{feature}/spec.md` â€” generated by `specify`
- `specs/{feature}/plan.md` â€” generated by `plan`
- `specs/{feature}/tasks.md` â€” generated by `tasks`
- `specs/{feature}/research.md` â€” generated by `plan`

Optional artifacts (generated as needed):
- `specs/{feature}/contracts/` â€” API contracts
- `specs/{feature}/data-model.md` â€” data models
- `specs/{feature}/quickstart.md` â€” validation scenarios

Sequence (brainstorming agent executes, review agent orchestrates):
1. (optional) `specify init` â€” new project or empty repo only
2. `specify` â€” WHAT/WHY only, mark ambiguities with [NEEDS CLARIFICATION]
3. `plan` â€” tech decisions with rationale, generates research.md
4. `tasks` â€” ordered task list, dependencies marked, [P] for parallel
5. `analyze` â€” cross-artifact consistency check (spec â†” plan â†” tasks)

Consistency check output levels:
- Critical: blocks Step 2, must fix and re-check
- Warning: may cause issues, should address
- Info: optimization suggestions

## 4) Step 2 / 2.5 / 3

- Step 2: coding agent executes per tasks.md â†’ create `S1` snapshot.
- Step 2.5: coding agent self-runs smoke test (compile, unit tests, basic function).
  - FAIL â†’ self-fix max 2 times â†’ still FAIL â†’ enter Step 4 with failure logs.
- Step 3: cross-model review â€” the opposite model family reviews the code.
  - Type A (coding=sonnet/Claude): review uses codex/high.
  - Type B (coding=codex/GPT): review uses sonnet/medium.
  - Dispute arbitration: triggered when reviewer raises issues and coder rebuts.
    - Arbitration: review(opus/medium) + coding(codex/xhigh) each state their case.
    - If coder does not rebut â†’ reviewer verdict stands, no arbitration.
  - Verdict: `PASS` / `PASS_WITH_NOTES` / `NEEDS_FIX`.
  - Rules: 0 crit + 0 major + 0 minor â†’ PASS; 0 crit + 0 major + minor â‰¤ 3 â†’ PASS_WITH_NOTES; else â†’ NEEDS_FIX.
  - Step 3 `PASS` or `PASS_WITH_NOTES` â†’ create `S2` snapshot.
  - `PASS_WITH_NOTES`: minor fix diff â‰¤ G2 â†’ skip re-review; diff > G2 â†’ downgrade to NEEDS_FIX.

## 5) Weighted Diff Gates

Formula: `sum(changed_lines * weight)`
- critical paths: weight `2`
- others: weight `1`
- G2 threshold: 20 weighted lines (PASS_WITH_NOTES guard)
- G3 threshold: 30 weighted lines (TF return-to-review guard)

## 6) Step 4 Repair Loop

- Max 3 rounds. Each round must carry full context bundle.
- Context bundle: original requirement + current diff + review JSON + prior round diffs/feedback + smoke logs.
- Round progression:
  1. brainstorming Sonnet/medium + coding Codex/medium â†’ Step 3
  2. brainstorming Sonnet/medium + coding Codex/medium â†’ Step 3
  3. brainstorming Opus/high + coding Codex/xhigh â†’ Step 3
- After round 3 still `NEEDS_FIX` â†’ Step 5.5.

## 7) Step 5 Test + TF Path

- Step 5 pass â†’ create `S3` snapshot â†’ Step 6.
- Step 5 fail â†’ TF path.

TF branch:
- TF-1: coding direct fix + test rerun
- TF-2: brainstorming Opus/medium + coding fix + test rerun
- TF-3: brainstorming Opus/high + coding fix + test rerun + full regression

If TF-1/2 diff exceeds G3, return to Step 3 with ReEntry budget (ReEntry++).
If ReEntry > ReEntry_MAX, force Step 5.5.
TF-3 always returns to Step 3 (ReEntry++).

## 8) Bounded Loop Rules

- TF â†’ Step 3 returns require `ReEntry <= ReEntry_MAX (2)`; otherwise force Step 5.5.
- Step 4 loop bounded by 3 rounds.
- Epoch loop bounded by 3 Epochs.

## 9) Step 5.5 Epoch Fallback

Entry: Step4-R3 fail or TF-3 fail.

Restart options (choose per Epoch):
- rollback to S1
- rollback to S2
- continue without rollback

Each Epoch:
- R1: brainstorming sonnet/medium â†’ coding fix â†’ incremental test
- R2: brainstorming sonnet/medium â†’ coding fix â†’ incremental test
- Epoch end â†’ full regression test

If Epoch > 3:
- only halt point reached
- start 30-minute timeout fallback
- on timeout: GPT(/think high) generates diagnosis + degraded delivery from S2 + notify monitor + notify æ™¨æ˜Ÿ

## 10) Step 6 / 7 Delivery Contract

- Step 6: docs agent generates/updates documentation (skip for L1).
  - Input: final diff + original requirement + review JSON summary + spec-kit artifacts.
  - Model: minimax/think high.
- Step 7: review agent assembles final payload, must include:
  - completed scope
  - changed files
  - test results
  - review conclusion
  - level (L1/L2/L3)
  - delivery status (`normal` or `degraded`)
  - snapshot tags (`S1`, `S2`, `S3`)

## 11) Monitor Alert Rules

| Trigger | Level | Target |
|---------|-------|--------|
| Step 1.5 consistency check fail | âš ï¸ | ç›‘æ§ç¾¤ |
| Step 2.5 smoke self-fix 2x still FAIL | âš ï¸ | ç›‘æ§ç¾¤ |
| L1 auto-upgrade to L2 | â„¹ï¸ | ç›‘æ§ç¾¤ |
| PASS_WITH_NOTES diff > G2 downgrade | â„¹ï¸ | ç›‘æ§ç¾¤ |
| TF diff > G3 return to review | â„¹ï¸ | ç›‘æ§ç¾¤ |
| TF ReEntry budget consumed | âš ï¸ | ç›‘æ§ç¾¤ |
| ReEntry exhausted, force Step 5.5 | ğŸš¨ | ç›‘æ§ç¾¤ |
| Step 4 enters Round 3 | âš ï¸ | ç›‘æ§ç¾¤ |
| Enter Epoch loop | ğŸš¨ | ç›‘æ§ç¾¤ |
| Any step timeout | âš ï¸ | ç›‘æ§ç¾¤ + æ™¨æ˜Ÿ |
| Epoch halt | ğŸš¨ | ç›‘æ§ç¾¤ + æ™¨æ˜Ÿ |
| HALT timeout degraded delivery | ğŸš¨ | ç›‘æ§ç¾¤ + æ™¨æ˜Ÿ |

## 12) Model Cross Principle

```
coding(sonnet/medium) dev â†’ review(codex/high) cross-review + test(codex/medium)
coding(codex/medium) dev â†’ review(sonnet/medium) cross-review + test(sonnet/medium)
Dispute arbitration: reviewer raises issue + coder rebuts â†’ review(opus/medium) + coding(codex/xhigh)
Repair escalation: sonnet/medium + codex/medium â†’ sonnet/medium + codex/medium â†’ opus/high + codex/xhigh
```
